import pandas as pd
import matplotlib.pyplot as plt
from sqlalchemy import create_engine
from fastapi import FastAPI
import uvicorn

# üì¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
engine = create_engine("sqlite:///company.db")

# üß© Task 1 ‚Äî CSV ‚Üí SQL
# –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
employees_df = pd.read_csv("employees.csv")
employees_df.to_sql("employees", con=engine, if_exists="replace", index=False)

# üß© Task 2 ‚Äî SQL Query: salary > 5000
query_high_salary = """
SELECT * FROM employees
WHERE salary > 5000
ORDER BY salary DESC
"""
high_salary_df = pd.read_sql(query_high_salary, con=engine)
print("üí∞ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π > 5000:\n", high_salary_df)

# üß© Task 3 ‚Äî JOIN + Aggregation
# –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ departments.csv
departments_df = pd.DataFrame({
    "dept_id": [1, 2, 3],
    "department_name": ["IT", "HR", "Finance"]
})
departments_df.to_csv("departments.csv", index=False)
departments_df.to_sql("departments", con=engine, if_exists="replace", index=False)

# JOIN: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ + –æ—Ç–¥–µ–ª—ã
join_query = """
SELECT e.id, e.name, d.department_name, e.salary
FROM employees e
JOIN departments d ON e.department = d.dept_id
"""
joined_df = pd.read_sql(join_query, con=engine)
print("üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –æ—Ç–¥–µ–ª–æ–≤:\n", joined_df)

# –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º
avg_salary_query = """
SELECT d.department_name, AVG(e.salary) AS avg_salary
FROM employees e
JOIN departments d ON e.department = d.dept_id
GROUP BY d.department_name
"""
avg_salary_df = pd.read_sql(avg_salary_query, con=engine)
print("üìä –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º:\n", avg_salary_df)

# üß© Task 4 ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã –≤ IT
update_query = """
UPDATE employees
SET salary = salary * 1.1
WHERE department = 1
"""
with engine.connect() as conn:
    conn.execute(update_query)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
updated_df = pd.read_sql("SELECT * FROM employees", con=engine)
print("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:\n", updated_df)

# üß© Task 5 ‚Äî –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
plot_df = pd.read_sql("""
SELECT d.department_name, e.salary
FROM employees e
JOIN departments d ON e.department = d.dept_id
""", con=engine)

avg_plot = plot_df.groupby("department_name")["salary"].mean()
avg_plot.plot(kind="bar", title="Average Salary by Department")
plt.ylabel("Salary")
plt.tight_layout()
plt.savefig("avg_salary.png")
plt.show()

# üéØ Optional ‚Äî FastAPI Report Generator
app = FastAPI()

@app.get("/employees")
def get_employees():
    df = pd.read_sql("SELECT * FROM employees", con=engine)
    return df.to_dict(orient="records")

@app.get("/avg-salary")
def get_avg_salary():
    df = pd.read_sql(avg_salary_query, con=engine)
    return df.to_dict(orient="records")

@app.get("/top-earners")
def get_top_earners():
    df = pd.read_sql("SELECT * FROM employees ORDER BY salary DESC LIMIT 3", con=engine)
    return df.to_dict(orient="records")

# –ó–∞–ø—É—Å–∫ FastAPI (–ª–æ–∫–∞–ª—å–Ω–æ)
# if __name__ == "__main__":
#     uvicorn.run(app, host="127.0.0.1", port=8000)
